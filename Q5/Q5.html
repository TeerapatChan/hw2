<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <head>
    <title>Q5 â€” Wildlife Trafficking Choropleth</title>
    <script src="../lib/d3.v5.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 18px;
      }
      h2 {
        margin: 0 0 10px 0;
      }
      #controls {
        margin-bottom: 10px;
      }
      #yearDropdown {
        padding: 6px;
        font-size: 14px;
      }
      svg#choropleth {
        width: 1000px;
        height: 600px;
        border: 1px solid #ddd;
        background: #fafafa;
        display: block;
      }
      .country {
        stroke: white;
        stroke-width: 0.4px;
        cursor: pointer;
      }
      .no-data {
        fill: gray;
      }
      #legend text {
        font-size: 12px;
      }
      #gt {
        margin-top: 8px;
        font-size: 13px;
      }
      .d3-tip {
        pointer-events: none;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #999;
        padding: 6px;
        border-radius: 3px;
        font-size: 13px;
      }
    </style>
  </head>

  <body>
    <h2>Wildlife Trafficking Incidents by Country</h2>

    <div id="controls">
      Select Year:
      <select id="yearDropdown"></select>
    </div>

    <svg id="choropleth" width="1000" height="600" viewBox="0 0 1000 600">
      <g id="countries"></g>
      <g id="legend"></g>
    </svg>

    <div id="gt">GT Username: <strong id="gtname">npallapangkul3</strong></div>

    <script>
      const svg = d3.select("#choropleth");
      const width = +svg.attr("width");
      const height = +svg.attr("height");

      const LEGEND_WIDTH = 180;
      const COLOR_LIST = ["#feedde", "#fdbe85", "#fd8d3c", "#d94701"];
      const NO_DATA_COLOR = "gray";

      var projection = d3.geoNaturalEarth1();
      var path = d3.geoPath().projection(projection);

      let colorScale = d3.scaleQuantile().range(COLOR_LIST);

      console.log(colorScale);
      const tip = d3
        .tip()
        .attr("class", "d3-tip")
        .offset([-8, 0])
        .html((d) => {
          const cname = d.properties?.name || "N/A";
          const info = currentYearData[cname];
          return `<strong>Country: </strong>${cname}<br/>
          <strong>Year: </strong>${selectedYear}<br/>
          <strong>Number of Incidents: </strong>${
            info ? info.incidents : "N/A"
          }<br/>
          <strong>Average Fine (USD): </strong>${
            info && info.avgFine != null ? (+info.avgFine).toFixed(2) : "N/A"
          }<br/>
          <strong>Average Imprisonment (Years): </strong>${
            info && info.avgImpr != null ? (+info.avgImpr).toFixed(2) : "N/A"
          }`;
        });
      svg.call(tip);

      let dataByYear = {};
      let allYears = [];
      let selectedYear = null;
      let currentYearData = {};

      Promise.all([
        d3.json("data/world_countries.json"),
        d3.csv("data/wildlife_trafficking.csv", d3.autoType),
      ]).then(([world, csv]) => ready(null, world, csv));

      function ready(error, world, traffickingData) {
        if (error) {
          console.error(error);
          return;
        }

        traffickingData.forEach((row) => {
          const year = +row["Year"];
          const country = row["Country of Incident"];
          const incidents = +row["Number_of_Incidents"] || 0;
          const avgFine =
            row["Average_Fine"] != null ? +row["Average_Fine"] : null;
          const avgImpr =
            row["Average_Imprisonment"] != null
              ? +row["Average_Imprisonment"]
              : null;

          if (!dataByYear[year]) dataByYear[year] = {};
          dataByYear[year][country] = {
            incidents,
            avgFine,
            avgImpr,
          };
        });

        allYears = Object.keys(dataByYear)
          .map((d) => +d)
          .sort((a, b) => a - b);

        const dd = d3.select("#yearDropdown");
        dd.selectAll("option")
          .data(allYears)
          .enter()
          .append("option")
          .attr("value", (d) => d)
          .text((d) => d);

        selectedYear = allYears[0];
        dd.property("value", selectedYear);

        dd.on("change", function () {
          selectedYear = +this.value;
          createMapAndLegend(world, traffickingData, selectedYear);
        });

        projection.fitSize([width - LEGEND_WIDTH, height], world);

        createMapAndLegend(world, traffickingData, selectedYear);
      }

      function createMapAndLegend(world, traffickingData, selectedYear) {
        currentYearData = dataByYear[selectedYear] || {};

        const incidentsArr = Object.values(currentYearData).map(
          (d) => d.incidents
        );
        const domainForScale = incidentsArr.length > 0 ? incidentsArr : [0];
        colorScale.domain(domainForScale);

        const countries = svg
          .select("#countries")
          .selectAll("path")
          .data(world.features);

        countries
          .enter()
          .append("path")
          .attr("class", "country")
          .attr("d", path)
          .on("mouseover", function (d) {
            tip.show(d, this);
            d3.select(this).raise().style("stroke-width", 1);
            d3.select(this).raise().style("stroke", "black");
          })
          .on("mouseout", function (d) {
            tip.hide(d, this);
            d3.select(this).style("stroke-width", 0.4);
            d3.select(this).style("stroke", "white");
          })
          .merge(countries)
          .transition()
          .duration(350)
          .attr("d", path)
          .style("fill", function (d) {
            const cname = d.properties?.name || "Unknown";
            const info = currentYearData[cname];
            return info ? colorScale(info.incidents) : NO_DATA_COLOR;
          });

        countries.exit().remove();
        const legend = d3
          .legendColor()
          .shapeWidth(20)
          .shapeHeight(20)
          .orient("vertical")
          .labelFormat(d3.format(".2f"))
          .scale(colorScale);

        svg
          .select("#legend")
          .attr("transform", `translate(${width - LEGEND_WIDTH + 20},40)`)
          .call(legend);
      }
    </script>
  </body>
</html>
